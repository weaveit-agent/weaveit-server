name: Backend CI - Build, Test & Security

on:
  push:
    branches: ["dev", "master", "speed"]

env:
  # üü¢ Naming: weaveit-server-staging
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/weaveit-server-staging

jobs:
  # =========================
  # 1Ô∏è‚É£ Semgrep Security Scan
  # =========================
  semgrep:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >- 
            p/default
            p/typescript
            p/secrets
            p/express
            p/nodejs
          auditOn: push
        continue-on-error: true

  # =========================
  # 2Ô∏è‚É£ Build & Smoke Test
  # =========================
  build-and-test:
    name: Build & Smoke Test
    runs-on: ubuntu-latest
    needs: semgrep
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # A. Build Check (Node.js)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        # Using the network fix we discovered earlier
        run: |
          npm config set fetch-retries 5
          npm install --legacy-peer-deps

      - name: Verify Build
        # This confirms your tsup/tsc build works locally
        run: npm run build

      # B. Docker Build
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker Image
        run: |
          # Lowercase the repo owner for Docker compatibility
          REPO_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
          FULL_IMAGE="ghcr.io/${REPO_OWNER}/weaveit-server-staging:latest"
          
          docker build -t $FULL_IMAGE .
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV

      # C. Smoke Test (The Critical Part)
      - name: üß™ Test Container Startup
        run: |
          echo "Starting Backend Container..."
          
          # üü¢ We pass MOCK keys. The server will start, but DB calls will fail.
          # That is okay! We just want to check if the HTTP server listens.
          docker run -d --name test-backend \
            -p 8080:8080 \
            -e PORT=8080 \
            -e NODE_ENV=production \
            -e DATABASE_URL="postgresql://mockuser:mockpass@localhost:5432/mockdb" \
            -e OPENAI_API_KEY="sk-mock-key-for-testing-only" \
            -e WEBHOOK_SECRET="mock-secret" \
            -e WEBHOOK_URL="http://localhost:3001/api/webhooks/mock" \
            $FULL_IMAGE

          echo "‚è≥ Waiting 10s for boot..."
          sleep 10

          # 1. Did it crash immediately?
          if [ "$(docker inspect -f '{{.State.Running}}' test-backend)" = "false" ]; then
            echo "‚ùå Backend crashed on startup!"
            docker logs test-backend
            exit 1
          fi

          # 2. HTTP Health Check
          echo "Checking Health Endpoint..."
          # Note: This might return 500 because the Mock DB connection will fail.
          # We accept 200 OR 500. Both mean the server IS running and responding.
          # If the server was dead, we would get 000 (Connection Refused).
          status_code=$(curl --write-out %{http_code} --silent --output /dev/null http://localhost:3001/api/db/health)

          echo "Server responded with Status Code: $status_code"

          if [[ "$status_code" -eq 200 ]] || [[ "$status_code" -eq 500 ]]; then
             echo "‚úÖ Smoke test passed! Server is alive."
          else
             echo "‚ùå Server failed to respond (Status: $status_code)"
             docker logs test-backend
             exit 1
          fi
          
          docker rm -f test-backend

      # D. Push Staging Image (Only on Master)
      - name: Push Staging Image
        if: github.ref == 'refs/heads/master'
        run: docker push $FULL_IMAGE