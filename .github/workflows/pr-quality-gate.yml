name: üõë Quality Gate (PR -> Main)

on:
  pull_request:
    branches:
      - main  # üü¢ Only runs when merging to Production

jobs:
  ephemeral-test:
    name: üß™ Ephemeral Stack & API Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read # Required to pull the Frontend image

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 1. Spin up the Stack
      - name: üèóÔ∏è Spin up Ephemeral Stack
        run: |
          # Export owner for docker-compose variable
          export GITHUB_REPOSITORY_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
          
          echo "üöÄ Starting stack with Frontend Image: ghcr.io/$GITHUB_REPOSITORY_OWNER/weaveit-ui-staging:latest"
          
          docker compose -f docker-compose.test.yml up -d --build
          
          echo "‚è≥ Waiting 30s for database connection..."
          sleep 30

      # 2. Debug (if needed)
      - name: üîç Debug Container Status
        if: always()
        run: docker compose -f docker-compose.test.yml ps -a

      # 3. Integration Test (Focus on API)
      - name: üîó Verify API Endpoints
        run: |
          echo "Testing Backend Health..."
          curl --fail --retry 5 --retry-delay 2 http://localhost:3001/api/db/health || exit 1
          
          echo "Testing Frontend Reachability..."
          curl --fail http://localhost:3000 || echo "‚ö†Ô∏è Frontend not responding (Optional)"

          echo "‚úÖ Stack is healthy!"

      # 4. DAST Scan (OWASP ZAP - API Mode)
      # We scan the Backend API directly this time
      - name: üïµÔ∏è Run OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'http://localhost:3001/api/db/health' # Scan your API root or health check
          format: openapi
          cmd_options: '-a' 
        continue-on-error: true

      - name: üßπ Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down